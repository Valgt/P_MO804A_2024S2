{"uid": "1801-E", "url": "https://codeforces.com/contest/1801/problem/E", "tags": ["data structures", " divide and conquer", " dsu", " hashing", " trees"], "title": "1801-E", "statement": "E. Gasoline pricestime limit per test3.5 secondsmemory limit per test1024 megabytesinputstandard inputoutputstandard outputBerland — is a huge country consisting of $$$n$$$ cities. The road network of Berland can be represented as a root tree, that is, there is only $$$n - 1$$$ road in the country, and you can get from any city to any other exactly one way, if you do not visit any city twice. For the convenience of representing the country, for each city $$$i$$$, the city $$$p_i$$$ is fixed, equal to the first city to which you need to go from the city $$$i$$$ to get to the city $$$1$$$. In other words, the city $$$p_i$$$ is equal to the ancestor of the city $$$i$$$ if the tree is hung for the city $$$1$$$.There is one gas station in each city of Berland. Gas stations have special pricing, and for each gas station there is a fixed range of prices for which they are ready to sell gasoline. A gas station in the city with the number $$$i$$$ is ready to sell gasoline at any price from $$$l_i$$$ to $$$r_i$$$ inclusive.The King of Berland — is an exemplary family man, and for $$$m$$$ years, two sons were born to him every year. The king's children have been involved in public affairs since early childhood, and at the end of each year they check the honesty of gasoline prices. From birth, the king's children, who are born in the year $$$i$$$, are responsible for checking gasoline prices on the ways from the city of $$$a_i$$$ to the city of $$$b_i$$$ and from the city of $$$c_i$$$ to the city of $$$d_i$$$, respectively.The check is as follows: both children simultaneously start their journey from the cities $$$a_i$$$ and $$$c_i$$$, respectively. The first son of the king, born in the year $$$i$$$, moves along the path from the city $$$a_i$$$ to the city $$$b_i$$$, and the second  — from the city $$$c_i$$$ to the city $$$d_i$$$. Children check that the price of gasoline in the city of $$$a_i$$$ coincides with the price of gasoline in the city of $$$c_i$$$. Next, they check that the price of gasoline in the second city on the way from $$$a_i$$$ to $$$b_i$$$ coincides with the price in the second city on the way from $$$c_i$$$ to $$$d_i$$$. Then they repeat the same thing for a couple of third cities on their paths and so on. At the end, they check that the price of gasoline in the city of $$$b_i$$$ coincides with the price of gasoline in the city of $$$d_i$$$. It is guaranteed that the length of the path from the city $$$a_i$$$ to the city $$$b_i$$$ coincides with the length of the path from the city $$$c_i$$$ to the city $$$d_i$$$.Gas stations must strictly obey the laws, and therefore all checks of gasoline prices should not reveal violations. Help Berland gas stations find out how many ways they can set gasoline prices for $$$m$$$ years. In other words, for each $$$i$$$ from $$$1$$$ to $$$m$$$, calculate how many ways you can set gasoline prices at all gas stations so that after the birth of the first $$$i$$$ pairs of the king's children, all their checks did not reveal violations, and at any gas station the price was in the acceptable price range. Since the number of such methods can be large, calculate the answer modulo $$$10^9 + 7$$$.InputThe first line contains a single integer $$$n$$$ ($$$1 \\\\le n \\\\le 200\\\\,000$$$) — the number of cities in Berland.The second line contains $$$(n - 1)$$$ numbers $$$p_2,\\\\ p_3,\\\\ p_4,\\\\ \\\\ldots,\\\\ p_n$$$ ($$$1 \\\\le p_i \\\\le n$$$), where $$$p_i$$$ denotes the number of the next city on the way from city $$$i$$$ to city $$$1$$$.In each of the following lines, two integers are given $$$l_i$$$ and $$$r_i$$$ ($$$1 \\\\le l_i \\\\le r_i < 10^9+7$$$), specifying the acceptable range of prices at the gas station number $$$i$$$.The following line contains a single integer $$$m$$$ ($$$1 \\\\le m \\\\le 200\\\\,000$$$) — the number of years during which two sons were born to the king.In each of the following $$$m$$$ lines, four integers are given $$$a_i$$$, $$$b_i$$$, $$$c_i$$$ and $$$d_i$$$ ($$$1 \\\\le a_i, b_i, c_i, d_i \\\\le n$$$), specifying two paths on which the king's children will check gasoline prices, born in the year $$$i$$$. It is guaranteed that the length of the path between the cities $$$a_i$$$ and $$$b_i$$$ is equal to the length of the path between the cities $$$c_i$$$ and $$$d_i$$$.OutputIn $$$m$$$ lines, print one number each. The number in the $$$i$$$ line should be equal to the number of ways to set gasoline prices in all cities so that the king's children born in the years up to and including $$$i$$$ do not reveal violations in inspections. Output the numbers modulo $$$10^9 + 7$$$.ExamplesInput5 1 1 2 2 2 4 1 3 1 3 2 4 4 4 4 1 1 2 2 1 2 2 1 3 4 4 3 3 4 3 5Output18 18 4 0Input8 1 2 3 4 5 8 6 3 7 2 6 3 8 5 10 5 8 2 9 3 8 6 8 4 1 3 7 6 4 1 5 7 1 7 7 1 1 8 2 7Output720 120 120 1NoteConsider the first example.After the birth of the first two sons, the prices in the cities of $$$1$$$ and $$$2$$$ should be equal. In total, there are 2 ways to choose the same gasoline price for the cities of $$$1$$$ and $$$2$$$ so that it falls within the acceptable price range for these cities. So, there are only ways to set gasoline prices: $$$2 \\\\cdot 3 \\\\cdot 3 \\\\cdot 1 = 18$$$.The second pair of sons will check the prices on the paths $$$1 - 2$$$ and $$$2 - 1$$$. This means that gasoline prices in the cities of $$$1$$$ and $$$2$$$ must match, which is already being done. Therefore, after the birth of the second pair of sons, the answer did not change in any way.The third pair of sons will check the prices on the tracks $$$3 - 1 - 2 - 4$$$ and $$$4 - 2 - 1 - 3$$$. Then the price of non-gasoline in the city of $$$3$$$ should be equal to the price in the city of $$$4$$$, and the price in the city of $$$1$$$ should be equal to the price in the city of $$$2$$$. Prices in the cities of $$$1$$$ and $$$2$$$ are already the same. For the cities of $$$3$$$ and $$$4$$$, there are 2 ways to choose the same price for gasoline so that it falls within the acceptable price range for these cities. So, there are only ways to set gasoline prices: $$$2 \\\\cdot 2 \\\\cdot 1 = 4$$$.  The fourth pair of sons will check the prices on the tracks $$$3 - 1 - 2 - 4$$$ and $$$3 - 1 - 2 - 5$$$. This means that the prices in the cities of $$$4$$$ and $$$5$$$ should be equal, and since the prices in the cities of $$$3$$$ and $$$4$$$ already coincide, then in the cities of $$$3$$$, $$$4$$$ and $$$5$$$ there should be the same price for gasoline. The price of gasoline in the city of $$$3$$$ should be no more than 3, and the price of gasoline in the city of $$$5$$$ should be no less than 4. So, after the birth of the fourth pair of sons, there are no ways to set gasoline prices so that all checks are carried out and prices are in the required ranges.", "source": "CF", "vjudge": false, "processed": [{"prompt_md5": "f97a718a", "template_md5": "35d339e4", "result": "There are $n$ cities connected by a tree structure. Each city has a gas station with a price range for gasoline ($l_i$ to $r_i$). \n\nFor $m$ years, two children check the gasoline prices along specific paths:\n\n* Year $i$:\n    * Child 1 checks from city $a_i$ to $b_i$.\n    * Child 2 checks from city $c_i$ to $d_i$.\n\nThe paths have the same length.\n\nThe children check that the gasoline price at corresponding cities along the paths are equal.\n\nFind the number of ways to set gasoline prices for each gas station so that the children's checks do not reveal any violations for each year, considering the price ranges. The answer should be modulo $10^9 + 7$."}, {"prompt_md5": "c052310e", "template_md5": "465699a0", "result": "You are given a tree with $n$ cities. Each city has a range of acceptable gas prices.  You are also given $m$ pairs of paths, each consisting of two paths of the same length.  \n\nFor each year up to $m$, determine the number of ways to set gas prices in all cities so that the prices on the corresponding cities of each path in a pair are equal. The output should be the number of valid price configurations modulo $10^9 + 7$."}]}